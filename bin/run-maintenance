#!/usr/bin/env php
<?php
require_once __DIR__ . '/../autoload.php';

use Civicrm\DemographicsCensusComparison\Service\AuditLogger;
use Civicrm\DemographicsCensusComparison\Service\MaintenanceScheduler;
use Civicrm\DemographicsCensusComparison\Service\OrphanedDataCleaner;
use Civicrm\DemographicsCensusComparison\Settings\SettingsRepository;

$config = require __DIR__ . '/../config/settings.php';
$storageFile = __DIR__ . '/../data/settings.json';

$settings = new SettingsRepository($storageFile, $config);
$auditConfig = $settings->getAuditLogConfig();
$logger = new AuditLogger($auditConfig['path'], $auditConfig['retention_days']);

$orphanLocator = static function (): array {
    // Placeholder implementation - replace with a real lookup in production.
    return [];
};
$orphanRemover = static function (array $ids): int {
    // Placeholder implementation - replace with a real deletion routine in production.
    return count($ids);
};

$cleaner = new OrphanedDataCleaner($orphanLocator, $orphanRemover);
$scheduler = new MaintenanceScheduler($settings, $logger, $cleaner);
$scheduler->run();
